---
title: "5-other_packages"
author: "Nico Hahn"
date: "21 August 2019"
output: html_document
---

```{r, include=FALSE}
token <- "pk.eyJ1Ijoibmljb2hhaG4iLCJhIjoiY2p2YzU4ZWNiMWY4ZTQ2cGZsZHB5cDJzZiJ9.Sg3fJKvEhfkuhKx7aBBjZA"
honey <- read_sf("datasets/honey.shp")
colnames(honey)[3:8] <- c("Number_of_colonies", "Yield_per_colony",
                          "Total_production", "Stocks","Price_per_lb",
                          "Value_of_production"
                          )
honey2008 <- honey[honey$year == 2008, ]
honey2008_multiline <- st_cast(honey2008, "MULTILINESTRING")
bavaria <- st_read("datasets/bavaria.shp")
# nicer colnames
colnames(bavaria) <- c(
  "Ort", "Art", "BIP je Einwohner", "Durchschnittsalter",
  "Siedlungsdichte", "Arbeitslosenquote",
  "Beschaeftigtenquote", "Haushaltseinkommen",
  "Studierende", "Bevoelkerungsentwicklung", "geometry"
)
# turn values into numeric
bavaria$`BIP je Einwohner` <- as.numeric(as.character(
  bavaria$`BIP je Einwohner`
))
bavaria$Durchschnittsalter <- as.numeric(as.character(
  bavaria$Durchschnittsalter
))
bavaria$Siedlungsdichte <- as.numeric(as.character(
  bavaria$Siedlungsdichte
))
bavaria$Arbeitslosenquote <- as.numeric(as.character(
  bavaria$Arbeitslosenquote
))
bavaria$Beschaeftigtenquote <- as.numeric(as.character(
  bavaria$Beschaeftigtenquote
))
bavaria$Haushaltseinkommen <- as.numeric(as.character(
  bavaria$Haushaltseinkommen
))
bavaria$Studierende <- as.numeric(as.character(
  bavaria$Studierende
))
bavaria$Bevoelkerungsentwicklung <- as.numeric(
  as.character(bavaria$Bevoelkerungsentwicklung)
)
bavaria$Ort <- as.character(bavaria$Ort)
reg <- st_read("datasets/regbez_ex.kml")
# intersections
bavaria <- st_intersection(bavaria, reg)
# more data
autobahn <- st_read("datasets/autobahn.kml")
airports <- st_read("datasets/airports.kml")
europe_raster <- raster("datasets/elevation1x1_new.tif")
# load europe shapefiles
europe_shape <- read_sf("datasets/ne_50m_admin_0_countries/ne_50m_admin_0_countries.shp")
europe_shape <- europe_shape[europe_shape$CONTINENT == "Europe",]
# cities above populaiton of 1 million
cities <- world.cities[world.cities$pop >= 1000000, ]
cities <- cities %>% st_as_sf(coords = c("long", "lat"), crs = 4326) %>%
  st_cast("POINT")
cities <- st_intersection(cities, st_union(europe_shape))
flights_denver <- as.data.frame(read_csv("datasets/denver.csv"))
roads_hamburg <- read_sf("datasets/hamburg.shp")
bakeries <- read_sf("datasets/bakeries.kml")
```

# Karten mit ggplot2 und ggspatial
**ggplot2** ist eines der am häufigsten benutzten Pakete zur Datenvisualisierung in R. Es wird hauptsächlich in Verbindung mit normalen Daten verwendet, kann aber auch zur Darstellung von geographischen Daten benutzt werden. Um die Funktionalität zu erweitern, kann zusätzlich das Paket **ggspatial** genutzt werden. Dieses wurde entwickelt, um  geographische Objekte in **ggplot2** Ebene zu verwandeln. Dies beinhaltet Vektor-, Rasterdaten und Hintergrundkarten. Um Geodaten in **ggplot2** hinzuzufügen, können die Funktionen `geom_sf()`, `geom_sf_label()` und `geom_sf_text()` verwendet werden.
```{r, fig.align="center", fig.cap="Karte mit ggplot2"}
ggplot(data = honey2008) +
  geom_sf(aes(fill = Price_per_lb))
```
Mit `ggspatial` kann vorallem das Layout der Karte verändert werden. Es kann, wie auch in **tmap**, eine Maßstabsleiste, ein Kompass und eine Hintergrundkarte hinzugefügt werden:
```{r, message=FALSE, warning=FALSE, fig.align="center", fig.cap="Verwendung von ggplot2 und ggspatial"}
ggplot(data = honey2008) +
  annotation_map_tile(type = "stamenwatercolor") +
  geom_sf_label(aes(label = Price_per_lb)) +
  geom_sf(data = honey2008_multiline) +
  annotation_scale(location = "tl") +
  annotation_north_arrow(location = "br", which_north = "true") 
```

Timo Grossenbacher zeigt in seinem Blog, wie man mit **gplot2** leicht zu interpretierende Karten gestalten kann:

```{r, warning=FALSE,message=FALSE,include=FALSE}
theme_map <- function(...) {
  theme_minimal() +
  theme(
    text = element_text(family = "Ubuntu Regular", color = "#22211d"),
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    # panel.grid.minor = element_line(color = "#ebebe5", size = 0.2),
    panel.grid.major = element_line(color = "#ebebe5", size = 0.2),
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "#f5f5f2", color = NA), 
    panel.background = element_rect(fill = "#f5f5f2", color = NA), 
    legend.background = element_rect(fill = "#f5f5f2", color = NA),
    panel.border = element_blank(),
    ...
  )
}
data <- read.csv("switzerland/input/avg_age_15.csv", stringsAsFactors = FALSE)
gde_15 <- readOGR("switzerland/input/geodata/gde-1-1-15.shp", layer = "gde-1-1-15")
# set crs to ch1903/lv03, just to make sure  (EPSG:21781)
crs(gde_15) <- "+proj=somerc +lat_0=46.95240555555556 
+lon_0=7.439583333333333 +k_0=1 +x_0=600000 +y_0=200000 
+ellps=bessel +towgs84=674.374,15.056,405.346,0,0,0,0 +units=m +no_defs"
# fortify, i.e., make ggplot2-compatible
map_data_fortified <- fortify(gde_15, region = "BFS_ID") %>% 
  mutate(id = as.numeric(id))
# now we join the thematic data
map_data <- map_data_fortified %>% left_join(data, by = c("id" = "bfs_id"))

# whole municipalities
gde_15_political <- readOGR("switzerland/input/geodata/g1g15.shp", layer = "g1g15")
crs(gde_15_political) <- "+proj=somerc +lat_0=46.95240555555556 
+lon_0=7.439583333333333 +k_0=1 +x_0=600000 +y_0=200000 
+ellps=bessel +towgs84=674.374,15.056,405.346,0,0,0,0 +units=m +no_defs"
map_data_political_fortified <- fortify(gde_15_political, region = "GMDNR") %>% 
  mutate(id = as.numeric(id))
map_data_political <- map_data_political_fortified %>% left_join(data, by = c("id" = "bfs_id"))
map_data_political <- map_data_political[complete.cases(map_data_political),]
# read in background relief
relief <- raster("switzerland/input/geodata/02-relief-georef-clipped-resampled.tif")
relief_spdf <- as(relief, "SpatialPixelsDataFrame")
# relief is converted to a very simple data frame, 
# just as the fortified municipalities.
# for that we need to convert it to a 
# SpatialPixelsDataFrame first, and then extract its contents 
# using as.data.frame
relief <- as.data.frame(relief_spdf) %>% 
  dplyr::rename(value = `X02.relief.georef.clipped.resampled`)
# remove unnecessary variables
rm(relief_spdf)
rm(gde_15)
rm(map_data_fortified)
rm(map_data_political_fortified)
pretty_breaks <- c(40,42,44,46,48)
# find the extremes
minVal <- min(map_data$avg_age_15, na.rm = T)
maxVal <- max(map_data$avg_age_15, na.rm = T)
# compute labels
labels <- c()
brks <- c(minVal, pretty_breaks, maxVal)
# round the labels (actually, only the extremes)
for(idx in 1:length(brks)){
  labels <- c(labels,round(brks[idx + 1], 2))
}

labels <- labels[1:length(labels)-1]
# define a new variable on the data set just as above
map_data$brks <- cut(map_data$avg_age_15, 
                     breaks = brks, 
                     include.lowest = TRUE, 
                     labels = labels)

brks_scale <- levels(map_data$brks)
labels_scale <- rev(brks_scale)
```
```{r, fig.align="center",fig.cap="Karte der Schweiz in ggplot2", warning=FALSE,message=FALSE}
ggplot() +
    # raster comes as the first layer, municipalities on top
    geom_raster(data = relief, aes(x = x, 
                                  y = y, 
                                  alpha = value)) +
    # use the "alpha hack"
    scale_alpha(name = "", range = c(0.6, 0), guide = F)  + 
    # municipality polygons
    geom_polygon(data = map_data, aes(fill = brks, 
                                      x = long, 
                                      y = lat, 
                                      group = group)) +
    # municipality outline
    geom_path(data = map_data, aes(x = long, 
                                   y = lat, 
                                   group = group), 
              color = "white", size = 0.1) +
    # apart from that, nothing changes
    coord_equal() +
    theme_map() +
    theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5),
          plot.subtitle = element_text(hjust = 0.5)) +
    labs(x = NULL, 
         y = NULL, 
         title = "Switzerland's regional demographics", 
         subtitle = "Average age in Swiss municipalities, 2015", 
         caption = "Geometries: ThemaKart, BFS; Data: BFS, 2016; Relief: swisstopo, 2016") + 
    scale_fill_manual(
      values = rev(scico(8, palette = "davos")[2:7]),
      breaks = rev(brks_scale),
      name = "Average age",
      drop = FALSE,
      labels = labels_scale,
      guide = guide_legend(
        direction = "horizontal",
        keyheight = unit(2, units = "mm"), 
        keywidth = unit(70/length(labels), units = "mm"),
        title.position = 'top',
        title.hjust = 0.5,
        label.hjust = 1,
        nrow = 1,
        byrow = T,
        reverse = T,
        label.position = "bottom"
      )
    )
```

[@ggswitz]


## Weiterführende Links
Für mehr Informationen zu der Verwendung von **ggplot** siehe https://ggplot2.tidyverse.org/reference/ggsf.html. [@ggplot2link]
Für mehr Informationen zu der Verwendung von **ggspatial** siehe https://paleolimbot.github.io/ggspatial/. [@ggspatiallink]