---
title: "Interaktive Karten"
author: "Nico Hahn"
date: "16 August 2019"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
library(spData)
library(spDataLarge)
library(tmap)
library(sf)
library(colourpicker)
library(stringr)
library(viridis)
library(maps)
library(raster)
library(grid)
library(leaflet)
# load shapefiles for bavaria
bavaria <- st_read("datasets/bavaria.shp")
# keep some data
bavaria <- bavaria[, c(2, 3, 14, 38, 42, 49, 58, 71, 88, 112, 132)]
# nicer colnames
colnames(bavaria) <- c(
  "Ort", "Art", "BIP je Einwohner", "Durchschnittsalter",
  "Siedlungsdichte", "Arbeitslosenquote",
  "Beschaeftigtenquote", "Haushaltseinkommen",
  "Studierende", "Bevoelkerungsentwicklung", "geometry"
)
# turn values into numeric
bavaria$`BIP je Einwohner` <- as.numeric(as.character(
  bavaria$`BIP je Einwohner`
))
bavaria$Durchschnittsalter <- as.numeric(as.character(
  bavaria$Durchschnittsalter
))
bavaria$Siedlungsdichte <- as.numeric(as.character(
  bavaria$Siedlungsdichte
))
bavaria$Arbeitslosenquote <- as.numeric(as.character(
  bavaria$Arbeitslosenquote
))
bavaria$Beschaeftigtenquote <- as.numeric(as.character(
  bavaria$Beschaeftigtenquote
))
bavaria$Haushaltseinkommen <- as.numeric(as.character(
  bavaria$Haushaltseinkommen
))
bavaria$Studierende <- as.numeric(as.character(
  bavaria$Studierende
))
bavaria$Bevoelkerungsentwicklung <- as.numeric(
  as.character(bavaria$Bevoelkerungsentwicklung)
)
bavaria$Ort <- as.character(bavaria$Ort)
Encoding(bavaria$Ort) <- "latin"
# load europe elevation raster
europe_raster <- raster("datasets/elevation1x1_new.tif")
# load europe shapefiles
europe_shape <- read_sf("datasets/ne_50m_admin_0_countries/ne_50m_admin_0_countries.shp")
europe_shape <- europe_shape[europe_shape$CONTINENT == "Europe",]
# cities above populaiton of 1 million
cities <- world.cities[world.cities$pop >= 1000000, ]
cities <- cities %>% st_as_sf(coords = c("long", "lat"), crs = 4326) %>%
  st_cast("POINT")
cities <- st_intersection(cities, st_union(europe_shape))
europe_shape <- st_cast(europe_shape, "MULTILINESTRING")

rosenheim <- read_sf("datasets/rosenheim.shp")

us <- read.csv("datasets/us_energy_census.csv")
honey <- read.csv("honeyproduction.csv")
abrev <- readxl::read_xlsx("abbrev.xlsx")
```

# Interaktive Karten
Ein Nachteil von statischen Karten ist, dass diese immer das selbe abbilden. Damit ist gemeint, es wird nur ein Bereich gezeigt und alle Informationen werden direkt dargestellt. Interaktive Karten verbessern normale Karten dahingegend, dass sie dem Betrachter die Möglichkeit geben das Aussehen der Karten zu beeinflussen und zusätzliche Informationen bereitstellen können. Die am häufigsten vorkommende Art von Interaktivität ist das verschieben und zoomen der dargestellten Karte und das Anzeigen zusätzlicher Informationen bei dem Klick auf einzelne geometrische Objekte. In **tmap** kann durch die Funktion `tmap_mode("view")` zu jeder Karte Interaktivität hinzugefügt werden. Mit `tmap_mode("plot")` wird diese wieder entfernt.
```{r, fig.align="center", fig.cap="Interaktive Bayernkarte"}
tmap_mode("view")
tm_shape(bavaria) + tm_polygons(col = "Bevoelkerungsentwicklung", midpoint = 0)
```

Alternativ kann die Karte auch durch `tmap_leaflet()` erstellt werden. Wie zu erkennen ist, kann bei der interaktiven Karten zwischen mehreren Hintergrundkarten gewählt werden. Um eine bestimmte Karten als Hintergrund zu verwenden, kann die Funktion `tm_basemap()` verwendet werden.
```{r, fig.align="center", fig.cap="Andere Hintergrundkarte"}
tm_shape(bavaria) + tm_polygons(col = "Bevoelkerungsentwicklung", midpoint = 0) +
  tm_basemap("Stamen.Watercolor")
```

Alle Karten und deren Namen können unter dem folgenden Link betrachtet werden:
https://leaflet-extras.github.io/leaflet-providers/preview/

Auch facettierte Karten können im interaktiven Modus dargestellt werden:

```{r, warning=FALSE, fig.align="center", fig.cap="Facettierte interaktive Karte"}
tm_shape(bavaria) + tm_polygons(col = "Arbeitslosenquote") + tm_facets(by = "Art")
```


Interaktive Karten sind auch gut geeignet, um sich einen ersten Überblick über einen Datensatz zu verschaffen. 
In dem folgenden Beispiel werden Unfälle in drei Londoner Stadtteilen in 2017 dargestellt. Zuerst wird der Datensatz geladen, Unfälle aus dem Jahr 2017 ausgewählt und Daten ohne bekannten Standort entfernt.
```{r}
accidents <- read.csv("datasets/Accident_Information.csv")
accidents <- accidents[accidents$Year == 2017, ]
accidents <- accidents[!is.na(accidents$Latitude), ]
```

Als nächstes wird der Datensatz in ein `sf` Objekt verwandelt.
```{r}
accidents <- accidents %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326) %>%
  st_cast("POINT")
```

Danach werden Londoner Shapefiles geladen und die Intersections zwischen den beiden Datensätze gesucht.
```{r, message=FALSE, warning=FALSE}
london <- read_sf("datasets/London_Borough_Excluding_MHW.shp") %>%
  st_transform(4326)
london_union <- st_union(london)
accidents_m <- st_intersects(london_union, accidents)
accidents <- accidents[unlist(accidents_m), ]
```

Damit es nicht zu unübersichtlich wird, werden nur drei Stadteile ausgewählt.
```{r}
london <- london[london$NAME %in% c("City of London", "Westminster", "Camden"), ]
london <- st_union(london)
accidents_m <- st_intersects(london, accidents)
accidents <- accidents[unlist(accidents_m), ]
```

Jetzt muss nur noch die Karte dargestellt werden. Dafür wird zuerst die Variable `Light_Conditions` für eine schönere Legende sortiert, ehe die Karte geplotted wird. Jeder Punkt stellt einen Unfall dar und bei einem Klick darauf werden mehr Informationen dargestellt.

```{r, fig.align="center", fig.cap="center"}
# do some ordering for the legend
accidents$Light_Conditions <- ordered(accidents$Light_Conditions,
                                      levels = c(
                                        "Daylight",
                                        "Darkness - lights lit",
                                        "Darkness - lighting unknown",
                                        "Darkness - lights unlit",
                                        "Darkness - no lighting",
                                        "Data missing or out of range"
                                      ))
# define the map
map_london <- tm_shape(accidents) +
  tm_dots(group = "2017", col = "Light_Conditions", palette = "Dark2",
          popup.vars = TRUE) +
  tm_view(alpha = 1,
          basemaps = "Esri.WorldTopoMap")
map_london
```

